name: Build & Deploy FTP

on:
  push:
    tags:
      - '[0-9]*.[0-9]*.[0-9]*'  # X.Y.Z

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag is on master
        run: |
          echo "üîé V√©rification du tag sur master"
          if ! git branch --contains "$GITHUB_SHA" | grep -q "master"; then
            echo "‚ùå Le tag n'a pas √©t√© cr√©√© sur master. Annulation."
            exit 1
          fi
          echo "‚úî Tag OK"

      - name: Install Firefox
        run: |
          sudo apt-get update
          sudo apt-get install -y firefox-esr

      - name: Install Geckodriver
        run: |
          GECKO_VERSION=$(curl -s https://api.github.com/repos/mozilla/geckodriver/releases/latest | grep tag_name | cut -d '"' -f 4)
          wget https://github.com/mozilla/geckodriver/releases/download/$GECKO_VERSION/geckodriver-$GECKO_VERSION-linux64.tar.gz
          tar -xzf geckodriver-*.tar.gz
          sudo mv geckodriver /usr/local/bin/

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Run make.py (generate HTML + images)
        env:
          CREDLY_ID: ${{ secrets.CREDLY_ID }}
          ROOTME_USER: ${{ secrets.ROOTME_USER }}
          TRYHACKME_USERNAME: ${{ secrets.TRYHACKME_USERNAME }}
        run: |
          python maker.py

      # Ajout automatique des images t√©l√©charg√©es
      - name: Commit downloaded images
        run: |
          echo "üìÅ V√©rification des images t√©l√©charg√©es‚Ä¶"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Ajouter uniquement les images
          git add images/ || true

          if ! git diff --cached --quiet; then
            echo "üñºÔ∏è Nouvelles images d√©tect√©es ‚Üí commit + push"
            git commit -m "Add downloaded images [CI]"
            git push
          else
            echo "‚úî Aucune nouvelle image"
          fi

      # Pr√©parer les fichiers pour l‚Äôupload FTPS
      - name: Build deployment folder
        run: |
          mkdir dist
          cp -r . dist/

          # Supprimer les fichiers √† ne PAS uploader
          rm -f dist/maker.py
          rm -f dist/service.py
          rm -f dist/README.md
          rm -f dist/requirements.txt
          rm -f dist/model.html
          rm -f dist/.gitignore
          rm -rf dist/.github
          rm -rf dist/.git
          rm -rf dist/__pycache__

          echo "üì¶ Dossier dist/ pr√©par√© pour le d√©ploiement"

      # Upload FTPS (tous les fichiers r√©cursivement)
      - name: Upload all files via FTP
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_TARGET_PATH: ${{ secrets.FTP_TARGET_PATH }}
        run: |
          echo "üì§ Upload FTPS‚Ä¶"

          find dist -type f | while read file; do
            relative_path="${file#dist/}"
            remote_path="$FTP_TARGET_PATH/$relative_path"

            echo "‚Üí Upload : $relative_path"

            curl --ftp-ssl -T "$file" \
              --user "$FTP_USER:$FTP_PASSWORD" \
              "ftps://$FTP_HOST/$remote_path"
          done

          echo "‚úî D√©ploiement termin√©"
